SELECT CODFILIAL,
       DTLIBERA,
       EXTRACT(HOUR FROM CAST(DTLIBERA AS TIMESTAMP))  AS HORA_LIBERA,
       DATA                                            AS DATA_PEDIDO,
       HORA                                            AS HORA_PEDIDO,
       COUNT(NUMPED)                                   AS QT_PED,
       COUNT(CASE WHEN POSICAO <> 'B' THEN NUMPED END) AS QT_PED_LIB,
       COUNT(CASE WHEN POSICAO = 'B' THEN NUMPED END)  AS QT_PED_BLOQ
FROM (SELECT PCPEDC.CODFILIAL,
             PCPEDC.DTLIBERA,
             PCPEDC.DATA,
             PCPEDC.HORA,
             PCPEDC.MINUTO,
             PCPEDC.POSICAO,
             PCPEDC.NUMPED
      FROM PCPEDC
      WHERE PCPEDC.DATA BETWEEN TRUNC(SYSDATE, 'MM') AND LAST_DAY(TRUNC(SYSDATE, 'MM'))
        AND (PCPEDC.POSICAO = 'B' OR (PCPEDC.POSICAO <> 'B' AND PCPEDC.CODFUNCLIBERA IS NOT NULL)))
GROUP BY CODFILIAL, DTLIBERA, DATA, HORA, MINUTO
